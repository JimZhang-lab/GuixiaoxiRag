"""
æŸ¥è¯¢è·¯ç”±
å¤„ç†æ™ºèƒ½æŸ¥è¯¢ã€æ„å›¾åˆ†æã€æ‰¹é‡æŸ¥è¯¢ç­‰åŠŸèƒ½
"""
from fastapi import APIRouter, HTTPException

from model import (
    BaseResponse, QueryRequest, BatchQueryRequest, 
    QueryIntentAnalysisRequest, SafeQueryRequest,
    QueryResponse, BatchQueryResponse, QueryIntentAnalysisResponse,
    SafeQueryResponse
)
from api.query_api import QueryAPI

# åˆ›å»ºè·¯ç”±å™¨
router = APIRouter(prefix="/api/v1", tags=["æŸ¥è¯¢"])

# åˆ›å»ºAPIå¤„ç†å™¨å®ä¾‹
query_api = QueryAPI()


@router.post(
    "/query",
    summary="æ™ºèƒ½çŸ¥è¯†æŸ¥è¯¢",
    description="""
    åŸºäºçŸ¥è¯†å›¾è°±å’Œå‘é‡æ£€ç´¢çš„æ™ºèƒ½æŸ¥è¯¢ç³»ç»Ÿï¼Œæ”¯æŒå¤šç§æŸ¥è¯¢æ¨¡å¼å’Œå‚æ•°ä¼˜åŒ–ã€‚

    **ğŸš€ æ ¸å¿ƒç‰¹æ€§ï¼š**
    - å¤šæ¨¡æ€æ£€ç´¢ï¼ˆå‘é‡+çŸ¥è¯†å›¾è°±ï¼‰
    - æ™ºèƒ½æŸ¥è¯¢ç†è§£å’Œæ‰©å±•
    - ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„ç­”æ¡ˆç”Ÿæˆ
    - å®æ—¶æµå¼å“åº”æ”¯æŒ
    - å¤šè¯­è¨€æŸ¥è¯¢æ”¯æŒ

    **â±ï¸ è¶…æ—¶é…ç½®ï¼š**
    - é»˜è®¤LLMè¯·æ±‚è¶…æ—¶ï¼š240ç§’
    - å¯é€šè¿‡.envçš„LLM_TIMEOUTé…ç½®è°ƒæ•´
    - æ”¯æŒæŸ¥è¯¢çº§åˆ«çš„è¶…æ—¶æ§åˆ¶

    **ğŸ¯ æŸ¥è¯¢æ¨¡å¼è¯¦è§£ï¼š**
    - **local**: æœ¬åœ°æ¨¡å¼ - ä¸“æ³¨äºä¸Šä¸‹æ–‡ç›¸å…³ä¿¡æ¯ï¼Œé€‚åˆç²¾ç¡®æŸ¥è¯¢
    - **global**: å…¨å±€æ¨¡å¼ - åˆ©ç”¨å…¨å±€çŸ¥è¯†å›¾è°±ï¼Œé€‚åˆå¹¿æ³›ä¸»é¢˜æŸ¥è¯¢
    - **hybrid**: æ··åˆæ¨¡å¼ - ç»“åˆæœ¬åœ°å’Œå…¨å±€æ£€ç´¢ï¼ˆğŸŒŸæ¨èï¼‰
    - **naive**: æœ´ç´ æ¨¡å¼ - æ‰§è¡ŒåŸºæœ¬å‘é‡æœç´¢ï¼Œé€Ÿåº¦æœ€å¿«
    - **mix**: æ··åˆæ¨¡å¼ - æ•´åˆçŸ¥è¯†å›¾è°±å’Œå‘é‡æ£€ç´¢ï¼Œé€‚åˆå¤æ‚æŸ¥è¯¢
    - **bypass**: ç»•è¿‡æ¨¡å¼ - ç›´æ¥è¿”å›æ£€ç´¢ç»“æœï¼Œç”¨äºè°ƒè¯•

    **ğŸ“Š æ€§èƒ½æ¨¡å¼ï¼š**
    - **fast**: å¿«é€Ÿæ¨¡å¼ - ä¼˜å…ˆå“åº”é€Ÿåº¦ï¼Œé€‚åˆå®æ—¶äº¤äº’
    - **balanced**: å¹³è¡¡æ¨¡å¼ - å…¼é¡¾é€Ÿåº¦å’Œè´¨é‡ï¼ˆé»˜è®¤ï¼‰
    - **quality**: è´¨é‡æ¨¡å¼ - ä¼˜å…ˆç»“æœè´¨é‡ï¼Œé€‚åˆæ·±åº¦åˆ†æ

    **ğŸ”§ å‚æ•°è¯´æ˜ï¼š**
    - query: æŸ¥è¯¢å†…å®¹ï¼ˆå¿…å¡«ï¼Œ1-2000å­—ç¬¦ï¼‰
    - mode: æŸ¥è¯¢æ¨¡å¼ï¼ˆå¯é€‰ï¼Œé»˜è®¤hybridï¼‰
    - top_k: è¿”å›ç»“æœæ•°é‡ï¼ˆå¯é€‰ï¼Œ1-50ï¼Œé»˜è®¤20ï¼‰
    - stream: æ˜¯å¦æµå¼è¿”å›ï¼ˆå¯é€‰ï¼Œé»˜è®¤falseï¼‰
    - only_need_context: ä»…è¿”å›ä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•ï¼‰
    - only_need_prompt: ä»…è¿”å›æç¤ºè¯ï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•ï¼‰
    - response_type: å“åº”ç±»å‹ï¼ˆå¯é€‰ï¼Œtext/json/markdownï¼‰
    - knowledge_base: çŸ¥è¯†åº“åç§°ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨å½“å‰çŸ¥è¯†åº“ï¼‰
    - language: å›ç­”è¯­è¨€ï¼ˆå¯é€‰ï¼Œä¸­æ–‡/Englishç­‰ï¼‰
    - performance_mode: æ€§èƒ½æ¨¡å¼ï¼ˆå¯é€‰ï¼Œé»˜è®¤balancedï¼‰

    **ğŸ’¡ ä½¿ç”¨å»ºè®®ï¼š**
    - æ—¥å¸¸æŸ¥è¯¢æ¨èä½¿ç”¨hybridæ¨¡å¼
    - éœ€è¦å¿«é€Ÿå“åº”æ—¶ä½¿ç”¨fastæ€§èƒ½æ¨¡å¼
    - å¤æ‚åˆ†ææŸ¥è¯¢ä½¿ç”¨qualityæ€§èƒ½æ¨¡å¼
    - è°ƒè¯•æ—¶å¯ä½¿ç”¨only_need_contextæŸ¥çœ‹æ£€ç´¢ç»“æœ

    **ğŸŒŠ æµå¼å“åº”ï¼š**
    - è®¾ç½® `stream: true` å¯ç”¨æµå¼å“åº”
    - æµå¼å“åº”ä½¿ç”¨ Server-Sent Events (SSE) æ ¼å¼
    - å“åº”ç±»å‹åŒ…æ‹¬ï¼šmetadataï¼ˆå…ƒæ•°æ®ï¼‰ã€contentï¼ˆå†…å®¹å—ï¼‰ã€doneï¼ˆå®Œæˆï¼‰ã€errorï¼ˆé”™è¯¯ï¼‰
    - é€‚ç”¨äºé•¿æ–‡æœ¬ç”Ÿæˆå’Œå®æ—¶äº¤äº’åœºæ™¯
    """,
    responses={
        200: {
            "description": "æŸ¥è¯¢æˆåŠŸ",
            "content": {
                "application/json": {
                    "examples": {
                        "normal_query": {
                            "summary": "æ™®é€šæŸ¥è¯¢æˆåŠŸ",
                            "value": {
                                "success": True,
                                "message": "æŸ¥è¯¢å®Œæˆ",
                                "data": {
                                    "answer": "äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯...",
                                    "context": ["ç›¸å…³æ–‡æ¡£ç‰‡æ®µ1", "ç›¸å…³æ–‡æ¡£ç‰‡æ®µ2"],
                                    "sources": ["doc1.pdf", "doc2.txt"],
                                    "confidence": 0.95,
                                    "response_time": 1.25,
                                    "mode_used": "hybrid",
                                    "tokens_used": 1024
                                }
                            }
                        },
                        "context_only": {
                            "summary": "ä»…è¿”å›ä¸Šä¸‹æ–‡",
                            "value": {
                                "success": True,
                                "message": "ä¸Šä¸‹æ–‡æ£€ç´¢å®Œæˆ",
                                "data": {
                                    "context": ["æ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£ç‰‡æ®µ"],
                                    "sources": ["source1.pdf"],
                                    "similarity_scores": [0.95, 0.87, 0.82]
                                }
                            }
                        }
                    }
                },
                "text/event-stream": {
                    "examples": {
                        "streaming_query": {
                            "summary": "æµå¼æŸ¥è¯¢å“åº”",
                            "value": """data: {"type": "metadata", "data": {"mode": "mix", "query": "ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ", "knowledge_base": "cs_college", "language": "ä¸­æ–‡", "stream": true}}

data: {"type": "content", "data": "äººå·¥æ™ºèƒ½"}

data: {"type": "content", "data": "ï¼ˆAIï¼‰æ˜¯"}

data: {"type": "content", "data": "è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯..."}

data: {"type": "done", "data": {"response_time": 1.25}}"""
                        }
                    }
                }
            }
        },
        422: {
            "description": "å‚æ•°éªŒè¯å¤±è´¥",
            "content": {
                "application/json": {
                    "example": {
                        "detail": [
                            {
                                "loc": ["body", "query"],
                                "msg": "æŸ¥è¯¢å†…å®¹ä¸èƒ½ä¸ºç©º",
                                "type": "value_error"
                            }
                        ]
                    }
                }
            }
        },
        408: {
            "description": "æŸ¥è¯¢è¶…æ—¶",
            "content": {
                "application/json": {
                    "example": {
                        "detail": "æŸ¥è¯¢è¶…æ—¶ï¼Œè¯·å°è¯•ç®€åŒ–æŸ¥è¯¢æˆ–è°ƒæ•´è¶…æ—¶è®¾ç½®"
                    }
                }
            }
        },
        500: {
            "description": "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯",
            "content": {
                "application/json": {
                    "example": {
                        "detail": "æŸ¥è¯¢å¤„ç†å¤±è´¥: çŸ¥è¯†åº“è¿æ¥é”™è¯¯"
                    }
                }
            }
        }
    }
)
async def query(request: QueryRequest):
    """æ™ºèƒ½çŸ¥è¯†æŸ¥è¯¢"""
    return await query_api.query(request)


# @router.post(
#     "/query/safe",
#     response_model=BaseResponse,
#     summary="å®‰å…¨æ™ºèƒ½æŸ¥è¯¢",
#     description="""
#     ç»“åˆæ„å›¾åˆ†æå’Œå®‰å…¨æ£€æŸ¥çš„æ™ºèƒ½æŸ¥è¯¢ï¼Œç¡®ä¿æŸ¥è¯¢å†…å®¹çš„å®‰å…¨æ€§ã€‚
    
#     **å¤„ç†æµç¨‹ï¼š**
#     1. æŸ¥è¯¢æ„å›¾åˆ†æ
#     2. å®‰å…¨çº§åˆ«è¯„ä¼°
#     3. æŸ¥è¯¢å¢å¼ºï¼ˆå¦‚æœå®‰å…¨ï¼‰
#     4. æ‰§è¡ŒæŸ¥è¯¢ï¼ˆå¦‚æœé€šè¿‡å®‰å…¨æ£€æŸ¥ï¼‰
    
#     **å®‰å…¨ç‰¹æ€§ï¼š**
#     - è‡ªåŠ¨è¯†åˆ«å’Œæ‹’ç»ä¸å½“æŸ¥è¯¢
#     - æä¾›å®‰å…¨æ›¿ä»£å»ºè®®
#     - è®°å½•å¯ç–‘æŸ¥è¯¢è¡Œä¸º
#     - æ”¯æŒæŸ¥è¯¢å¢å¼ºå’Œä¼˜åŒ–
    
#     **å‚æ•°è¯´æ˜ï¼š**
#     - query: æŸ¥è¯¢å†…å®¹ï¼ˆå¿…å¡«ï¼‰
#     - mode: æŸ¥è¯¢æ¨¡å¼ï¼ˆå¯é€‰ï¼‰
#     - knowledge_base: çŸ¥è¯†åº“åç§°ï¼ˆå¯é€‰ï¼‰
#     - language: æŸ¥è¯¢è¯­è¨€ï¼ˆå¯é€‰ï¼‰
#     - enable_intent_analysis: æ˜¯å¦å¯ç”¨æ„å›¾åˆ†æï¼ˆå¯é€‰ï¼‰
#     - enable_query_enhancement: æ˜¯å¦å¯ç”¨æŸ¥è¯¢å¢å¼ºï¼ˆå¯é€‰ï¼‰
#     - safety_check: æ˜¯å¦è¿›è¡Œå®‰å…¨æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
    
#     **ä½¿ç”¨ç¤ºä¾‹ï¼š**
#     ```json
#     {
#         "query": "äººå·¥æ™ºèƒ½çš„å‘å±•å†å²",
#         "mode": "hybrid",
#         "knowledge_base": "ai_kb",
#         "enable_intent_analysis": true,
#         "enable_query_enhancement": true,
#         "safety_check": true
#     }
#     ```
#     """
# )
# async def safe_query(request: SafeQueryRequest):
#     """å®‰å…¨æ™ºèƒ½æŸ¥è¯¢"""
#     return await query_api.safe_query(request)


@router.get(
    "/query/modes",
    response_model=BaseResponse,
    summary="è·å–æŸ¥è¯¢æ¨¡å¼åˆ—è¡¨",
    description="""
    è·å–æ‰€æœ‰æ”¯æŒçš„æŸ¥è¯¢æ¨¡å¼åŠå…¶è¯¦ç»†è¯´æ˜ã€‚
    
    **è¿”å›ä¿¡æ¯ï¼š**
    - æŸ¥è¯¢æ¨¡å¼åˆ—è¡¨
    - æ¯ç§æ¨¡å¼çš„è¯¦ç»†æè¿°
    - æ¨èä½¿ç”¨åœºæ™¯
    - æ€§èƒ½ç‰¹ç‚¹
    
    **æŸ¥è¯¢æ¨¡å¼å¯¹æ¯”ï¼š**
    - local: é€‚åˆä¸Šä¸‹æ–‡ç›¸å…³çš„ç²¾ç¡®æŸ¥è¯¢
    - global: é€‚åˆéœ€è¦å…¨å±€çŸ¥è¯†çš„å¹¿æ³›æŸ¥è¯¢
    - hybrid: å¹³è¡¡ç²¾ç¡®æ€§å’Œè¦†ç›–é¢ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯
    - naive: ç®€å•å¿«é€Ÿï¼Œé€‚åˆåŸºç¡€æŸ¥è¯¢
    - mix: ç»¼åˆå¤šç§æ£€ç´¢æ–¹æ³•ï¼Œé€‚åˆå¤æ‚æŸ¥è¯¢
    - bypass: ç›´æ¥æ¨¡å¼ï¼Œé€‚åˆæµ‹è¯•å’Œè°ƒè¯•
    """
)
async def get_query_modes():
    """è·å–æŸ¥è¯¢æ¨¡å¼åˆ—è¡¨"""
    return await query_api.get_query_modes()


@router.post(
    "/query/batch",
    response_model=BaseResponse,
    summary="æ‰¹é‡æŸ¥è¯¢å¤„ç†",
    description="""
    é«˜æ•ˆæ‰¹é‡å¤„ç†å¤šä¸ªæŸ¥è¯¢è¯·æ±‚ï¼Œæ”¯æŒå¹¶è¡Œå¤„ç†å’Œæ™ºèƒ½è°ƒåº¦ã€‚

    **ğŸš€ æ‰¹é‡å¤„ç†ä¼˜åŠ¿ï¼š**
    - å¹¶è¡Œå¤„ç†æå‡æ•´ä½“æ•ˆç‡
    - æ™ºèƒ½è´Ÿè½½å‡è¡¡
    - èµ„æºå¤ç”¨å‡å°‘å¼€é”€
    - ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

    **â±ï¸ è¶…æ—¶æ§åˆ¶ï¼š**
    - å•æ¡LLMè¯·æ±‚è¶…æ—¶ï¼š240ç§’ï¼ˆå¯é€šè¿‡.envé…ç½®ï¼‰
    - æ‰¹é‡èšåˆè¶…æ—¶ï¼šé€šè¿‡body.timeoutæ§åˆ¶ï¼ˆé»˜è®¤300ç§’ï¼‰
    - æ”¯æŒæŸ¥è¯¢çº§åˆ«çš„ç‹¬ç«‹è¶…æ—¶

    **ğŸ“Š å¤„ç†ç­–ç•¥ï¼š**
    - **å¹¶è¡Œæ¨¡å¼**ï¼šåŒæ—¶å¤„ç†å¤šä¸ªæŸ¥è¯¢ï¼ˆé»˜è®¤ï¼‰
    - **ä¸²è¡Œæ¨¡å¼**ï¼šæŒ‰é¡ºåºå¤„ç†ï¼Œé€‚åˆèµ„æºå—é™ç¯å¢ƒ
    - **æ··åˆæ¨¡å¼**ï¼šæ ¹æ®æŸ¥è¯¢å¤æ‚åº¦åŠ¨æ€è°ƒæ•´

    **ğŸ”§ å‚æ•°è¯´æ˜ï¼š**
    - queries: æŸ¥è¯¢åˆ—è¡¨ï¼ˆå¿…å¡«ï¼Œ1-50ä¸ªæŸ¥è¯¢ï¼‰
    - mode: æŸ¥è¯¢æ¨¡å¼ï¼ˆå¯é€‰ï¼Œåº”ç”¨äºæ‰€æœ‰æŸ¥è¯¢ï¼Œé»˜è®¤hybridï¼‰
    - top_k: æ¯ä¸ªæŸ¥è¯¢è¿”å›ç»“æœæ•°é‡ï¼ˆå¯é€‰ï¼Œ1-20ï¼Œé»˜è®¤10ï¼‰
    - knowledge_base: çŸ¥è¯†åº“åç§°ï¼ˆå¯é€‰ï¼‰
    - language: å›ç­”è¯­è¨€ï¼ˆå¯é€‰ï¼Œç»Ÿä¸€åº”ç”¨ï¼‰
    - parallel: æ˜¯å¦å¹¶è¡Œå¤„ç†ï¼ˆå¯é€‰ï¼Œé»˜è®¤trueï¼‰
    - timeout: æ‰¹é‡å¤„ç†è¶…æ—¶æ—¶é—´ï¼ˆå¯é€‰ï¼Œé»˜è®¤300ç§’ï¼‰
    - max_concurrent: æœ€å¤§å¹¶å‘æ•°ï¼ˆå¯é€‰ï¼Œé»˜è®¤5ï¼‰
    - retry_failed: æ˜¯å¦é‡è¯•å¤±è´¥çš„æŸ¥è¯¢ï¼ˆå¯é€‰ï¼Œé»˜è®¤falseï¼‰

    **ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–ï¼š**
    - æ™ºèƒ½æ‰¹æ¬¡åˆ†ç»„
    - ç¼“å­˜å¤ç”¨æœºåˆ¶
    - åŠ¨æ€èµ„æºåˆ†é…
    - å®æ—¶è¿›åº¦åé¦ˆ

    **ğŸ›¡ï¸ å®¹é”™æœºåˆ¶ï¼š**
    - å•ä¸ªæŸ¥è¯¢å¤±è´¥ä¸å½±å“å…¶ä»–æŸ¥è¯¢
    - è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆå¯é…ç½®ï¼‰
    - è¯¦ç»†çš„é”™è¯¯åˆ†ç±»å’ŒæŠ¥å‘Š
    - éƒ¨åˆ†æˆåŠŸç»“æœè¿”å›

    **ğŸ’¡ ä½¿ç”¨å»ºè®®ï¼š**
    - ç›¸ä¼¼æŸ¥è¯¢å»ºè®®åˆ†ç»„å¤„ç†
    - å¤æ‚æŸ¥è¯¢é€‚å½“é™ä½å¹¶å‘æ•°
    - ç”Ÿäº§ç¯å¢ƒå»ºè®®å¯ç”¨é‡è¯•æœºåˆ¶
    """,
    responses={
        200: {
            "description": "æ‰¹é‡æŸ¥è¯¢å®Œæˆ",
            "content": {
                "application/json": {
                    "examples": {
                        "all_success": {
                            "summary": "å…¨éƒ¨æˆåŠŸ",
                            "value": {
                                "success": True,
                                "message": "æ‰¹é‡æŸ¥è¯¢å®Œæˆï¼š3ä¸ªæˆåŠŸï¼Œ0ä¸ªå¤±è´¥",
                                "data": {
                                    "total_queries": 3,
                                    "successful_queries": 3,
                                    "failed_queries": 0,
                                    "total_time": 5.2,
                                    "results": [
                                        {
                                            "query": "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ",
                                            "success": True,
                                            "answer": "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯...",
                                            "response_time": 1.8
                                        }
                                    ]
                                }
                            }
                        },
                        "partial_success": {
                            "summary": "éƒ¨åˆ†æˆåŠŸ",
                            "value": {
                                "success": True,
                                "message": "æ‰¹é‡æŸ¥è¯¢å®Œæˆï¼š2ä¸ªæˆåŠŸï¼Œ1ä¸ªå¤±è´¥",
                                "data": {
                                    "total_queries": 3,
                                    "successful_queries": 2,
                                    "failed_queries": 1,
                                    "total_time": 8.5,
                                    "results": [
                                        {
                                            "query": "æ­£å¸¸æŸ¥è¯¢",
                                            "success": True,
                                            "answer": "æŸ¥è¯¢ç»“æœ..."
                                        },
                                        {
                                            "query": "å¤±è´¥æŸ¥è¯¢",
                                            "success": False,
                                            "error": "æŸ¥è¯¢è¶…æ—¶"
                                        }
                                    ],
                                    "failed_queries_details": [
                                        {
                                            "query": "å¤±è´¥æŸ¥è¯¢",
                                            "error": "æŸ¥è¯¢è¶…æ—¶",
                                            "error_code": "TIMEOUT"
                                        }
                                    ]
                                }
                            }
                        }
                    }
                }
            }
        },
        422: {
            "description": "å‚æ•°éªŒè¯å¤±è´¥",
            "content": {
                "application/json": {
                    "example": {
                        "detail": [
                            {
                                "loc": ["body", "queries"],
                                "msg": "æŸ¥è¯¢åˆ—è¡¨ä¸èƒ½ä¸ºç©º",
                                "type": "value_error"
                            }
                        ]
                    }
                }
            }
        },
        413: {
            "description": "æŸ¥è¯¢æ•°é‡è¶…é™",
            "content": {
                "application/json": {
                    "example": {
                        "detail": "æŸ¥è¯¢æ•°é‡è¶…è¿‡é™åˆ¶ï¼ˆæœ€å¤š50ä¸ªï¼‰"
                    }
                }
            }
        }
    }
)
async def batch_query(request: BatchQueryRequest):
    """æ‰¹é‡æŸ¥è¯¢å¤„ç†"""
    return await query_api.batch_query(request)


@router.post(
    "/query/optimized",
    response_model=BaseResponse,
    summary="ä¼˜åŒ–å‚æ•°æŸ¥è¯¢",
    description="""
    ä½¿ç”¨æ€§èƒ½ä¼˜åŒ–å‚æ•°çš„æŸ¥è¯¢ï¼Œæ ¹æ®æŸ¥è¯¢æ¨¡å¼å’Œæ€§èƒ½è¦æ±‚è‡ªåŠ¨è°ƒæ•´å‚æ•°ã€‚

    è¶…æ—¶è¯´æ˜ï¼šé»˜è®¤å¤§æ¨¡å‹è¯·æ±‚è¶…æ—¶ä¸º 240 ç§’ï¼Œå¯é€šè¿‡ .env çš„ LLM_TIMEOUT é…ç½®è°ƒæ•´ã€‚

    **ä¼˜åŒ–ç‰¹æ€§ï¼š**
    - æ ¹æ®æŸ¥è¯¢æ¨¡å¼è‡ªåŠ¨ä¼˜åŒ–å‚æ•°
    - æ”¯æŒä¸åŒæ€§èƒ½çº§åˆ«ï¼ˆfast/balanced/qualityï¼‰
    - åŠ¨æ€è°ƒæ•´tokené™åˆ¶å’Œæ£€ç´¢å‚æ•°
    - æä¾›æ€§èƒ½ç›‘æ§å’Œå»ºè®®

    **æ€§èƒ½æ¨¡å¼ï¼š**
    - fast: å¿«é€Ÿæ¨¡å¼ï¼Œä¼˜å…ˆå“åº”é€Ÿåº¦
    - balanced: å¹³è¡¡æ¨¡å¼ï¼Œå…¼é¡¾é€Ÿåº¦å’Œè´¨é‡
    - quality: è´¨é‡æ¨¡å¼ï¼Œä¼˜å…ˆç»“æœè´¨é‡

    **å‚æ•°è¯´æ˜ï¼š**
    - query: æŸ¥è¯¢å†…å®¹ï¼ˆå¿…å¡«ï¼‰
    - mode: æŸ¥è¯¢æ¨¡å¼ï¼ˆå¯é€‰ï¼‰
    - performance_mode: æ€§èƒ½æ¨¡å¼ï¼ˆå¯é€‰ï¼‰
    - custom_params: è‡ªå®šä¹‰å‚æ•°ï¼ˆå¯é€‰ï¼‰
    """
)
async def optimized_query(request: dict):
    """ä½¿ç”¨ä¼˜åŒ–å‚æ•°çš„æŸ¥è¯¢"""
    return await query_api.optimized_query(request)


# å¯¼å‡ºè·¯ç”±å™¨
__all__ = ["router"]
